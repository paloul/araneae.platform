# Infrastructure Certificate Management with cert-manager

Instructions and scripts to install [cert-manager](https://cert-manager.io/)

## Prerequisite Supporting CLI Tools and Utilities

--------------------------------------------
* Cert-Manager kOps Addon 
  * https://kops.sigs.k8s.io/addons/#cert-manager
  * kOps has an add-on for cert-manager. Be sure it is enabled and defined in the kops cluster yaml definition.
  * The add-on auto generates a role for use by service accounts
    * A template is used to create the role name:
      * `cert-manager.kube-system.sa.{kops_cluster_domain}`
      * `cert-manager.kube-system.sa.dev.araneae.io` 
      * The role is granted the permissions to use Amazon Route53 and solve DNS01 ACME challenges 
  * Be sure the Hosted Zone ID is defined in the cert-manager config section in kops cluster config yaml:
    * ```
      certManager: # https://kops.sigs.k8s.io/addons/#cert-manager
        enabled: true
        hostedZoneIDs:
        - Z03766603NEQGG30JJN7 # araneae.io hosted zone
      ```

--------------------------------------------

### Step 1 - Cluster Issuer - https://cert-manager.io/docs/configuration/
The first thing to configure after cert-manager addon installation is the `ClusterIssuer`. The Cluster Issuer
represents Certificate Authority functionality on the cluster. It allows to sign certificates in response to
certificate signing requests.
We rely on ACME which are free and trusted by all major browsers by default. We use Let's Encrypt to provide the
functionality. More information can be found at the [cert-manager acme](https://cert-manager.io/docs/configuration/acme/) link.

Decide to use either prod or staging ClusterIssuer. These use different underlying Let's Encrypt APIs. The Staging
version does not have a request rate limit, while the Prod version has a rate limit. Certificates generated by Staging
can give some verification and validation errors for certificates on certain browsers. 

Open the Cluster Issuer YAML definition you wish to install and verify the Route53 Hosted Zone ID. This string value
should match what is defined in the kOps cluster yaml configuration under the cert-manager addon section. 

### Step 2 - Certificates
Once an Issuer has been configured, you can start to issue certificates. Certificates need to be created for all 
respective external facing applications with gateway routes, i.e. Argocd, Keycloak, Kubeflow, etc. To be used 
with the Istio load balancer certificates must be created in the same namespace as the `istio-ingressgateway` 
deployment, which in our case is the default `istio` namespace: `istio-system`. 

Here are some links to help create certificates for various use cases Araneae users:
* [Securing Istio Gateway](https://istio.io/docs/tasks/traffic-management/ingress/ingress-certmgr/): Secure your Istio Gateway in Kubernetes using cert-manager.
* [Securing Knative](https://knative.dev/docs/serving/encryption/enabling-automatic-tls-certificate-provisioning/): Secure your Knative services with trusted HTTPS certificates.

### Step 3 - Create an IAM User with Route53 privileges for DNS-01 Challenges
Since we rely on ACME DNS-01 challenges, the Cluster Issuer mentioned above needs to be able to modify Route53 records.
The simplest way is to create a new IAM User just for this purpose, granted only the ability to modify our Hosted Zone ID.

The JSON policy named `route53-Z03766603NEQGG30JJN7-policy.json` is provided as an example. The Hosted Zone ID in the policy needs
to match the Hosted Zone ID defined in the Cluster Issuer definition.
```bash
aws iam create-group --profile araneae --group-name certmanager-cluster-issuer

aws iam create-policy \
  --profile araneae \
  --policy-name certmanager-cluster-issuer-Z03766603NEQGG30JJN7 \
  --policy-document file://aws/route53-Z03766603NEQGG30JJN7-policy.json

aws iam attach-group-policy \
  --profile araneae \
  --group-name certmanager-cluster-issuer \
  --policy-arn arn:aws:iam::654383687924:policy/certmanager-cluster-issuer-Z03766603NEQGG30JJN7
  
aws iam create-user --profile araneae --user-name certmanager-cluster-issuer

aws iam add-user-to-group --profile araneae --user-name certmanager-cluster-issuer --group-name certmanager-cluster-issuer

aws iam create-access-key --profile araneae --user-name certmanager-cluster-issuer
```

### Step 4 - Create Sealed Secret of IAM Access ID and Secret Key
```bash
./route53-credentials-secret.sh --accesskeyid iamuseraccessid --accesssecretkey iamuseraccesssecretkey
```

### Step 5 - Apply Kustomize YAML
```bash
kustomize build distribution/certificates/ | kubectl apply -f -
```